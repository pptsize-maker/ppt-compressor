<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - pptsize</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            text-align: center;
            color: #666;
        }

        .logo {
            font-size: 28px;
            color: #333;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .logo strong {
            color: #a31e22;
        }

        .message {
            font-size: 16px;
            margin: 20px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a31e22;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-link {
            margin-top: 30px;
        }

        .back-link a {
            color: #a31e22;
            text-decoration: none;
            font-size: 14px;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        /* ç®€å•çš„æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            margin-bottom: 15px;
            font-family: inherit;
        }

        .modal-input:focus {
            outline: none;
            border-color: #a31e22;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .modal-btn:hover:not(:disabled) {
            opacity: 0.9;
        }

        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-btn-primary {
            background: #a31e22;
            color: white;
        }

        .modal-btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .error-text {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ppt<strong>size</strong></div>
        <div class="message" id="statusMessage">Verifying reset link...</div>
        <div class="spinner" id="spinner"></div>
        <div class="back-link">
            <a href="/">â† Back to Home</a>
        </div>
    </div>

    <!-- å¯†ç è¾“å…¥æ¨¡æ€æ¡† -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-title">Enter New Password</div>
            <input 
                type="password" 
                id="newPassword" 
                class="modal-input" 
                placeholder="New password (at least 6 characters)"
                minlength="6"
            >
            <input 
                type="password" 
                id="confirmPassword" 
                class="modal-input" 
                placeholder="Confirm new password"
                minlength="6"
            >
            <div class="error-text" id="errorText"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancelBtn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="submitBtn">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="js/config/supabase-js@2.js"></script>
    <script src="js/config/env.js"></script>

    <script>
        const statusMessage = document.getElementById('statusMessage');
        const spinner = document.getElementById('spinner');
        const passwordModal = document.getElementById('passwordModal');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const errorText = document.getElementById('errorText');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        let isProcessing = false;
        let supabaseClient = null;

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, hideSpinner = false) {
            statusMessage.textContent = message;
            if (hideSpinner) {
                spinner.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            errorText.textContent = message;
        }

        // æ¸…é™¤é”™è¯¯
        function clearError() {
            errorText.textContent = '';
        }

        // æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
        function showPasswordModal() {
            spinner.style.display = 'none';
            passwordModal.classList.add('show');
            newPasswordInput.focus();
        }

        // éšè—å¯†ç è¾“å…¥æ¡†
        function hidePasswordModal() {
            passwordModal.classList.remove('show');
        }

        // æ£€æŸ¥ URL æ˜¯å¦æœ‰æ•ˆ
        function checkUrl() {
            const hash = window.location.hash;
            
            // è°ƒè¯•ï¼šæ‰“å°å®Œæ•´ URL å’Œ hash
            console.log('ğŸ” å®Œæ•´ URL:', window.location.href);
            console.log('ğŸ” Hash éƒ¨åˆ†:', hash);
            
            if (hash.includes('error=')) {
                const params = new URLSearchParams(hash.substring(1));
                const error = params.get('error');
                const errorDescription = params.get('error_description');
                
                if (error === 'access_denied' && errorDescription?.includes('expired')) {
                    showStatus('Reset link has expired. Please request a new one.', true);
                } else {
                    showStatus(errorDescription || 'Invalid reset link. Please request a new one.', true);
                }
                return false;
            }
            
            if (!hash.includes('access_token')) {
                showStatus('Invalid reset link. Please request a new one. (Check console for details)', true);
                console.error('âŒ URL ä¸­æ²¡æœ‰ access_token');
                console.log('ğŸ“§ è¯·æ£€æŸ¥é‚®ä»¶ä¸­çš„é“¾æ¥æ˜¯å¦å®Œæ•´');
                return false;
            }
            
            return true;
        }

        // åˆ›å»º Supabase å®¢æˆ·ç«¯ï¼ˆä¸æ¸…é™¤ URL hashï¼‰
        function createSupabaseClient() {
            const config = window.ENV.getSupabaseConfig();
            return window.supabase.createClient(config.url, config.anonKey);
        }

        // é‡ç½®å¯†ç 
        async function resetPassword() {
            if (isProcessing) return;

            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();

            clearError();

            // éªŒè¯
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            // å¼€å§‹å¤„ç†
            isProcessing = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';

            try {
                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                // æˆåŠŸ
                hidePasswordModal();
                showStatus('Password reset successfully! Redirecting...', true);
                
                // ç«‹å³è·³è½¬ï¼Œä¸ç­‰å¾…
                window.location.href = '/';

            } catch (error) {
                console.error('Reset failed:', error);
                
                let errorMessage = 'Failed to reset password';
                if (error.message?.includes('session')) {
                    errorMessage = 'Session expired. Please request a new reset link.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
                
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                // æ£€æŸ¥å¿…è¦çš„ä¾èµ–
                if (typeof window.supabase === 'undefined' || typeof window.ENV === 'undefined') {
                    showStatus('System error. Please try again later.', true);
                    return;
                }

                // åˆ›å»º Supabase å®¢æˆ·ç«¯ï¼ˆä¸ä¼šæ¸…é™¤ URL hashï¼‰
                supabaseClient = createSupabaseClient();
                console.log('âœ… Supabase å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');

                // æ£€æŸ¥ URL æ˜¯å¦æœ‰æ•ˆ
                if (!checkUrl()) {
                    return;
                }

                // URL æœ‰æ•ˆï¼Œç«‹å³æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
                showPasswordModal();

            } catch (error) {
                console.error('Initialization failed:', error);
                showStatus('Failed to initialize. Please refresh the page.', true);
            }
        }

        // äº‹ä»¶ç›‘å¬
        submitBtn.addEventListener('click', resetPassword);
        cancelBtn.addEventListener('click', () => {
            window.location.href = '/';
        });

        // Enter é”®æäº¤
        [newPasswordInput, confirmPasswordInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    resetPassword();
                }
            });
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

